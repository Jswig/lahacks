{% extends "layout.html" %} {% block content %}
<div class="container-fluid row align-items-end" id="mainPicture">
    <nav id="menu"></nav>
    <div id="map"></div>
</div>
<script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    crossorigin="anonymous"
></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js"></script>
<link
    rel="stylesheet"
    href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css"
    type="text/css"
/>
<script>
    mapboxgl.accessToken =
        "pk.eyJ1IjoiZ3psZWlzaW5nIiwiYSI6ImNrOGJmMnlzajA4OGUza3MyZ2gyNmRqZGEifQ.HDcR0vD84eVvS3mbM2eshA";
    var map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/navigation-guidance-night-v4",
        center: [-118.2437, 34.0522],
        zoom: 10,
        minZoom: 10
    });

    let bounds = [
        [-119, 33.5],
        [-117.5, 34.5]
    ];

    map.setMaxBounds(bounds);

    map.addControl(
        new MapboxDirections({
            accessToken: mapboxgl.accessToken
        }),
        "top-left"
    );

    map.addControl(new mapboxgl.NavigationControl());
    map.scrollZoom.disable();

    // HeatMap Layer
    // map.on(btnPress, function(){})
    map.on("load", function() {
        map.addSource("traffic", {
            type: "geojson",
            data: "./static/num_accidents.geojson"
        });

        map.addLayer({
            id: "Accident Heatmap",
            type: "heatmap",
            source: "traffic",
            maxzoom: 15,
            layout: { visibility: "none" },
            paint: {
                // increase weight as diameter breast height increases
                "heatmap-weight": {
                    property: "num_accidents",
                    type: "exponential",
                    stops: [
                        [1, 0],
                        [62, 1]
                    ]
                },
                // increase intensity as zoom level increases
                "heatmap-intensity": {
                    stops: [
                        [11, 1],
                        [15, 3]
                    ]
                },
                // assign color values be applied to points depending on their density
                "heatmap-color": [
                    "interpolate",
                    ["linear"],
                    ["heatmap-density"],
                    0,
                    "rgba(30, 250, 30, 0)",
                    0.2,
                    "rgb(140, 250, 30)",
                    0.4,
                    "rgb(250, 250, 30)",
                    0.6,
                    "rgb(250,140,30)",
                    0.8,
                    "rgb(250,30,30)"
                ],
                // increase radius as zoom increases
                "heatmap-radius": {
                    stops: [
                        [11, 15],
                        [15, 20]
                    ]
                },
                // decrease opacity to transition into the circle layer
                "heatmap-opacity": {
                    default: 1,
                    stops: [
                        [14, 1],
                        [15, 0]
                    ]
                }
            }
        });

        // Individual Points Layer
        map.addLayer({
            id: "traffic-point",
            type: "circle",
            source: "traffic",
            minzoom: 14,
            layout: { visibility: "visible" },
            paint: {
                // increase the radius of the circle as the zoom level and dbh value increases
                "circle-radius": {
                    property: "num_accidents",
                    type: "exponential",
                    stops: [
                        [{ zoom: 15, value: 1 }, 5],
                        [{ zoom: 15, value: 62 }, 10],
                        [{ zoom: 22, value: 1 }, 20],
                        [{ zoom: 22, value: 62 }, 50]
                    ]
                },
                "circle-color": {
                    property: "num_accidents",
                    type: "exponential",
                    stops: [
                        [0, "rgba(30,222,239,0)"],
                        [10, "rgb(30, 250, 140)"],
                        [20, "rgb(30, 250, 30)"],
                        [30, "rgb(140, 250, 30)"],
                        [40, "rgb(250, 250, 30)"],
                        [50, "rgb(250, 140, 30)"],
                        [60, "rgb(250, 30, 30)"]
                    ]
                },
                "circle-stroke-color": "white",
                "circle-stroke-width": 1,
                "circle-opacity": {
                    stops: [
                        [14, 0],
                        [15, 1]
                    ]
                }
            }
        });
    });

    var toggleableLayerIds = ["Accident Heatmap"];

    for (var i = 0; i < toggleableLayerIds.length; i++) {
        var id = toggleableLayerIds[i];

        var link = document.createElement("a");
        link.href = "#";
        link.className = "active";
        link.textContent = id;

        link.onclick = function(e) {
            var clickedLayer = this.textContent;
            console.log(clickedLayer);
            e.preventDefault();
            e.stopPropagation();

            var visibility = map.getLayoutProperty(clickedLayer, "visibility");

            if (visibility === "visible") {
                map.setLayoutProperty(clickedLayer, "visibility", "none");
                if (clickedLayer == "Accident Heatmap") {
                    map.setLayoutProperty(
                        "traffic-point",
                        "visibility",
                        "none"
                    );
                }
                this.className = "";
            } else {
                this.className = "active";
                map.setLayoutProperty(clickedLayer, "visibility", "visible");
                if (clickedLayer == "Accident Heatmap") {
                    map.setLayoutProperty(
                        "traffic-point",
                        "visibility",
                        "visible"
                    );
                }
            }
        };

        var layers = document.getElementById("menu");
        layers.appendChild(link);
    }

    var draw = new MapboxDraw({
        // Instead of showing all the draw tools, show only the line string and delete tools
        displayControlsDefault: false,
        controls: {
            line_string: true,
            trash: true
        },
        styles: [
            // Set the line style for the user-input coordinates
            {
                id: "gl-draw-line",
                type: "line",
                filter: [
                    "all",
                    ["==", "$type", "LineString"],
                    ["!=", "mode", "static"]
                ],
                layout: {
                    "line-cap": "round",
                    "line-join": "round"
                },
                paint: {
                    "line-color": "#438EE4",
                    "line-dasharray": [0.2, 2],
                    "line-width": 4,
                    "line-opacity": 0.7
                }
            },
            // Style the vertex point halos
            {
                id: "gl-draw-polygon-and-line-vertex-halo-active",
                type: "circle",
                filter: [
                    "all",
                    ["==", "meta", "vertex"],
                    ["==", "$type", "Point"],
                    ["!=", "mode", "static"]
                ],
                paint: {
                    "circle-radius": 12,
                    "circle-color": "#FFF"
                }
            },
            // Style the vertex points
            {
                id: "gl-draw-polygon-and-line-vertex-active",
                type: "circle",
                filter: [
                    "all",
                    ["==", "meta", "vertex"],
                    ["==", "$type", "Point"],
                    ["!=", "mode", "static"]
                ],
                paint: {
                    "circle-radius": 8,
                    "circle-color": "#438EE4"
                }
            }
        ]
    });

    // Add the draw tool to the map
    map.addControl(draw);

    // TODO input
    function findSafestRoute({ src: [x1, y1], dest: [x2, y2] }) {
        // draw.add({ type: 'Point', coordinates: [x1, y1] });

        // // find route
        // const interval = (abs(x1 - x2) + abs(y1 - y2)) / 95; // computes maximum route length assuming we are always moving towards destination
        // let currLoc = [x1, y1];
        // for(i = 0; i < 95; i++){
        //     // 3 properties
        //     // A) distance from currLoc, B) Safety (num_accidents), C) distance remaining to destination (amount of progress)

        // }

        // draw.add({ type: 'Point', coordinates: [x2, y2] });

        draw.add({ type: "Point", coordinates: [-118.47938, 34.27456] });
        draw.add({ type: "Point", coordinates: [-118.45938, 34.29456] });
        draw.add({ type: "Point", coordinates: [-118.435, 34.31456] });
        draw.add({ type: "Point", coordinates: [-118.415, 34.33456] });
        draw.add({ type: "Point", coordinates: [-118.39538, 34.35456] });
        draw.add({ type: "Point", coordinates: [-118.37538, 34.37456] });
        draw.add({ type: "Point", coordinates: [-118.34538, 34.39456] });
    }

    // Use the coordinates you drew to make the Map Matching API request
    function updateRoute() {
        // Set the profile
        var profile = "driving";
        // Get the coordinates that were drawn on the map
        findSafestRoute({ src: [0, 0], dest: [0, 0] });
        var data = draw.getAll();
        var lastFeature = data.features.length - 1;
        var coords = data.features[lastFeature].geometry.coordinates;
        // Format the coordinates
        var newCoords = coords.join(";");
        // Set the radius for each coordinate pair to 25 meters
        var radius = [];
        coords.forEach(element => {
            radius.push(25);
        });
        getMatch(newCoords, radius, profile);
    }

    // Make a Map Matching request
    function getMatch(coordinates, radius, profile) {
        // Separate the radiuses with semicolons
        var radiuses = radius.join(";");
        // Create the query
        var query =
            "https://api.mapbox.com/matching/v5/mapbox/" +
            profile +
            "/" +
            coordinates +
            "?geometries=geojson&radiuses=" +
            radiuses +
            "&steps=true&access_token=" +
            mapboxgl.accessToken;

        $.ajax({
            method: "GET",
            url: query
        }).done(function(data) {
            // Get the coordinates from the response
            var coords = data.matchings[0].geometry;
            console.log(coords);
            // Code from the next step will go here
        });
    }
    map.on("load", updateRoute);
</script>
{% endblock content %}
